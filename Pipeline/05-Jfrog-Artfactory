node {

// Get Artifactory Server Instace Details
def server = Artifactory.server "01"
def buildinfo =  Artifactory.newBuildInfo()

// Project Path 
def project_path = "04-App-Code/petclinic-code"

// Project Repo
def project_repo = "https://github.com/amitvashisttech/devops-m-benz-27-Jan-2022.git"

// Project Branch 
def project_branch = "main"



stage('Git - Test - CheckOut') {
  git branch: project_branch, url: project_repo
} 

dir(project_path) {

stage('Maven Clean') {
  sh 'mvn clean'
}

stage('Maven Compile') {
  sh 'mvn compile'
} 

stage('Maven Test') {
  sh 'mvn test'
}

stage('Maven Package') {
  sh 'mvn package'
}


stage('Build Management') {
		def uploadSpec = """{ 
			"files": [
			{
			"pattern": "**/*.war",
			"target": "petclinic-snapshot"
			}
		]

	}"""
	
	server.upload spec: uploadSpec
}

stage('Publish Build Info'){
   server.publishBuildInfo buildInfo
}




stage('Archive Artifacts') {
  archiveArtifacts artifacts: 'target/petclinic.war', followSymlinks: false
}


stage('Docker Deployment') {
  sh 'docker-compose up -d --build'
}

}
    
}


